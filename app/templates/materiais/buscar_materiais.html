<!-- Arquivo: templates/materiais/buscar_materiais.html -->
{% extends 'base.html' %}

{% block conteudo %}
<h2>üîé Buscar Materiais por Tipo</h2>

<!-- üîΩ Dropdown de tipos -->
<label for="tipo_id">Tipo de Material:</label><br>
<select id="tipo_id" class="form-control" style="margin-bottom: 10px;">
    <option value="">-- Selecione --</option>
    {% for tipo in tipos %}
        <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
    {% endfor %}
</select>

<!-- üî§ Campo de busca -->
<label for="busca">Nome do Material:</label><br>
<input type="text" id="busca" placeholder="Digite parte do nome..." class="form-control" style="margin-bottom: 10px;">

<!-- üìã Resultados -->
<div id="resultado" style="margin-top: 15px;"></div>

<!-- ‚öôÔ∏è Script AJAX -->
<script>
    // ‚è≥ Aguarda o carregamento completo do HTML antes de executar
    document.addEventListener('DOMContentLoaded', function () {
    
        // üîΩ Refer√™ncia ao select de tipos de material
        const tipoSelect = document.getElementById('tipo_id');
    
        // üî§ Refer√™ncia ao campo de busca por nome
        const buscaInput = document.getElementById('busca');
    
        // üì¶ Div onde os resultados da busca ser√£o exibidos dinamicamente
        const resultadoDiv = document.getElementById('resultado');
    
        // üîç Fun√ß√£o principal que faz a busca de materiais
        function buscarMateriais() {
            // Obt√©m o valor do tipo selecionado
            const tipo_id = tipoSelect.value;
    
            // Obt√©m o texto digitado pelo usu√°rio
            const busca = buscaInput.value;
    
            // ‚ö†Ô∏è Se nenhum tipo estiver selecionado, mostra aviso e sai da fun√ß√£o
            if (!tipo_id) {
                resultadoDiv.innerHTML = "<p>Selecione um tipo de material.</p>";
                return;
            }
    
            // üì° Envia requisi√ß√£o GET para o backend com os par√¢metros tipo_id e q
            fetch(`/materiais/buscar?tipo_id=${tipo_id}&q=${busca}`)
    
                // üîÑ Converte a resposta em JSON
                .then(res => res.json())
    
                // ‚úÖ Processa os dados recebidos
                .then(dados => {
                    // Se a resposta for uma lista vazia, mostra mensagem de nenhum encontrado
                    if (dados.length === 0) {
                        resultadoDiv.innerHTML = "<p>Nenhum material encontrado.</p>";
                    } else {
                        // üß± Monta a tabela HTML dinamicamente
                        let html = `
                        <table border="1" cellpadding="8" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                        `;
    
                        // Para cada material retornado, cria uma linha na tabela
                        dados.forEach(item => {
                            html += `
                                <tr>
                                    <td>${item.nome}</td>
                                    <td>
                                        <a href="/materiais/${item.id}/editar">‚úèÔ∏è Editar</a>
                                        <form action="/materiais/${item.id}/excluir" method="POST" style="display:inline;">
                                            <button type="submit" onclick="return confirm('Deseja excluir este material?')">üóëÔ∏è Excluir</button>
                                        </form>
                                    </td>
                                </tr>
                            `;
                        });
    
                        // Fecha a tabela e insere no resultado
                        html += "</tbody></table>";
                        resultadoDiv.innerHTML = html;
                    }
                })
    
                // ‚ö†Ô∏è Em caso de erro (ex: falha na conex√£o), mostra mensagem de erro
                .catch(() => {
                    resultadoDiv.innerHTML = "<p>Erro ao buscar materiais.</p>";
                });
        }
    
        // üîÑ Aciona a busca toda vez que o tipo for alterado
        tipoSelect.addEventListener('change', buscarMateriais);
    
        // üß† Aciona a busca a cada letra digitada no campo de busca
        buscaInput.addEventListener('input', buscarMateriais);
    });
    </script>
    
{% endblock %}
